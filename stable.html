<html>
    <head>
        <title>Welcome to the World of Bella Sara</title>
        <link rel="icon" href="./images/favicon.ico">
        <link rel="stylesheet" href="./style.css">
    </head>
    <head> 
        <meta charset="UTF-8" />
        <title>Making your first Phaser 3 Game - Part 3</title>
        <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
        <style type="text/css">
            body {
                margin: 0;
            }
        </style>
    </head>
    <body style="text-align: center; margin-top: 100px;">
        <div>
            <script type="text/javascript">

                play_music = true;
                hand = {
                    empty: 'empty',
                    shovel: 'shovel',
                    fork: 'fork',
                    fork_filled: 'fork_filled',
                    brush: 'brush',
                    small_brush: 'small_brush',
                    hoofpick: 'hoofpick',
                    apple: 'apple',
                    grain_scoop: 'grain_scoop'
                }
                handcurrent = hand.empty;
                waterfilled = false;
                foodfilled = false;

                shovel_held_sprite = null
                fork_held_sprite = null
                grain_held_sprite = null
                brush_held_sprite = null
                hoofpick_held_sprite = null

                class Example extends Phaser.Scene
                {

                    preload ()
                    {
                        this.load.image('stable', './images/stable/stable-bg.png');

                        this.load.spritesheet('shovel', './images/stable/shovel.png', { frameWidth: 77, frameHeight: 195 });
                        this.load.image('shovel_held', './images/stable/shovel_held.png');
                        this.load.spritesheet('fork', './images/stable/fork.png', { frameWidth: 75, frameHeight: 206 });
                        this.load.spritesheet('fork_held', './images/stable/fork_held.png', { frameWidth: 157, frameHeight: 167 });
                        this.load.spritesheet('straw1', './images/stable/straw1.png', { frameWidth: 216, frameHeight: 143 });
                        this.load.spritesheet('straw2', './images/stable/straw2.png', { frameWidth: 180, frameHeight: 126 });
                        this.load.spritesheet('straw3', './images/stable/straw3.png', { frameWidth: 236, frameHeight: 150 });
                        this.load.image('straw_bales', './images/stable/straw_bales.png');

                        this.load.spritesheet('trough', './images/stable/trough.png', { frameWidth: 263, frameHeight: 167 });
                        this.load.spritesheet('food_trough', './images/stable/food.png', { frameWidth: 139, frameHeight: 68 });
                        this.load.image('grain_bin', './images/stable/grain_bin.png');
                        this.load.image('grain_scoop', './images/stable/grain_scoop.png');
                        
                        this.load.image('brush_held', './images/stable/brush_held.png');
                        this.load.spritesheet('brush', './images/stable/brush.png', { frameWidth: 39, frameHeight: 44 });
                        this.load.image('hoofpick_held', './images/stable/hoofpick_held.png');
                        this.load.spritesheet('hoofpick', './images/stable/hoofpick.png', { frameWidth: 21, frameHeight: 68 });
                        this.load.spritesheet('horse', './images/stable/horse.png', { frameWidth: 528, frameHeight: 475 });
                        
                        this.load.spritesheet('music_button', './images/stable/music.png', { frameWidth: 36, frameHeight: 36 });

                        this.load.audio('background_music', ['./stable_soundtrack.mp3']);
                        this.load.audio('shovel_sound', ['./shovel_sound.mp3']);
                    }

                    create ()
                    {
                        const backgroundMusic = this.sound.add('background_music');
                        backgroundMusic.loop = true; 
                        backgroundMusic.play();

                        this.add.image(427, 251, 'stable');
                        const music_button = this.add.sprite(832, 480, 'music_button', 0).setInteractive({ pixelPerfect: true });

                        const straw2 = this.add.sprite(481, 387, 'straw2', 0).setInteractive();
                        const straw1 = this.add.sprite(315, 380, 'straw1', 0).setInteractive();
                        const straw3 = this.add.sprite(632, 376, 'straw3', 0).setInteractive();
                        const straw_bales = this.add.sprite(333, 45, 'straw_bales', 0).setInteractive();

                        const fork = this.add.sprite(735, 240, 'fork', 0).setInteractive({ pixelPerfect: true });
                        const shovel = this.add.sprite(759, 272, 'shovel', 0).setInteractive({ pixelPerfect: true });
                        const grain_bin = this.add.image(733, 415, 'grain_bin').setInteractive({ pixelPerfect: true });
                        const food_trough = this.add.sprite(139, 234, 'food_trough', 0).setInteractive({ pixelPerfect: true });
                        const brush = this.add.sprite(739, 110, 'brush', 0).setInteractive({ pixelPerfect: true });
                        const hoofpick = this.add.sprite(781, 99, 'hoofpick', 0).setInteractive({ pixelPerfect: true });

                        // trough
                        const trough = this.add.sprite(181, 418, 'trough', 0).setInteractive();
                        this.anims.create({
                            key: 'fill_water',
                            frames: this.anims.generateFrameNumbers('trough', { frames: [ 1, 2, 3 ] }),
                            frameRate: 8
                        });

                        // horse
                        const horse = this.add.sprite(370, 220, 'horse', 0)
                        this.anims.create({
                            key: 'drink_water',
                            frames: this.anims.generateFrameNumbers('horse', { frames: [ 0, 1, 0 ] }),
                            frameRate: 1,
                            delay: 250
                        });

                        // held items
                        fork_held_sprite = this.add.image(735, 240, 'fork_held').setVisible(false);
                        shovel_held_sprite = this.add.image(759, 272, 'shovel_held').setVisible(false);
                        grain_held_sprite = this.add.image(759, 272, 'grain_scoop').setVisible(false);
                        brush_held_sprite = this.add.image(759, 272, 'brush_held').setVisible(false);
                        hoofpick_held_sprite = this.add.image(759, 272, 'hoofpick_held').setVisible(false);

                        const shovel_sound = this.sound.add('shovel_sound');
                        
                        this.input.topOnly = true; // don't allow object to be interacted with when they are lower

                        music_button.on('pointerdown', function (pointer)
                        {
                            if (play_music) {
                                backgroundMusic.stop()
                                this.setFrame(1)
                            }
                            else {
                                backgroundMusic.play()
                                this.setFrame(0)
                            }
                            play_music = !play_music
                        });

                        // drink water
                        trough.on('pointerdown', function (pointer)
                        {
                            if (!waterfilled && handcurrent === hand.empty) {
                                waterfilled = true;
                                this.play('fill_water');
                                horse.play('drink_water');
                            }
                        });
                        
                        shovel.on('pointerdown', function (pointer)
                        {
                            set_tool(hand.shovel, shovel)
                        });
                        
                        fork.on('pointerdown', function (pointer)
                        {
                            if (handcurrent === hand.empty) {
                                handcurrent = hand.fork;
                                this.setFrame(1)
                            }
                            else if (handcurrent === hand.fork || handcurrent === hand.fork_filled) {
                                handcurrent = hand.empty;
                                this.setFrame(0)
                            }
                        });

                        straw_bales.on('pointerdown', function (pointer)
                        {
                            if (handcurrent === hand.fork) {
                                handcurrent = hand.fork_filled
                            }
                        });

                        function set_tool(tool, sprite) {
                            if (handcurrent === hand.empty) {
                                handcurrent = tool;
                                sprite.setFrame(1)
                            }
                            else if (handcurrent === tool) {
                                handcurrent = hand.empty;
                                sprite.setFrame(0)
                            }
                        }

                        function clean_straw(straw) {
                            if (handcurrent === hand.shovel && straw.frame.name === 0) {
                                straw.setFrame(1);
                                shovel_sound.play();
                            }
                            else if (handcurrent === hand.fork_filled && straw.frame.name === 1) {
                                straw.setFrame(2);
                                handcurrent = hand.fork
                            }
                        }
                        straw1.on('pointerdown', function (pointer) {clean_straw(straw1)});
                        straw2.on('pointerdown', function (pointer) {clean_straw(straw2)});
                        straw3.on('pointerdown', function (pointer) {clean_straw(straw3)});

                        grain_bin.on('pointerdown', function (pointer)
                        {
                            if (!foodfilled && handcurrent === hand.empty) {
                                handcurrent = hand.grain_scoop
                                grain_bin.setVisible(false)
                            }
                        });

                        food_trough.on('pointerdown', function (pointer)
                        {
                            console.log(foodfilled)
                            if (!foodfilled && handcurrent === hand.grain_scoop) {
                                handcurrent = hand.empty;
                                foodfilled = true;
                                grain_bin.setVisible(true);
                                this.setFrame(1);
                            }
                        });

                        brush.on('pointerdown', function (pointer)
                        {
                            set_tool(hand.brush, brush)
                        });

                        hoofpick.on('pointerdown', function (pointer)
                        {
                            set_tool(hand.hoofpick, hoofpick)
                        });
                    }

                    update ()
                    {
                        const pointer = this.input.activePointer;
                            
                        if (handcurrent === hand.shovel) {
                            shovel_held_sprite.setVisible(true).setPosition(pointer.worldX+15, pointer.worldY-30);
                        }
                        else if (handcurrent === hand.fork) {
                            fork_held_sprite.setFrame(0).setVisible(true).setPosition(pointer.worldX+20, pointer.worldY-20);
                        }
                        else if (handcurrent === hand.fork_filled) {
                            fork_held_sprite.setFrame(1).setVisible(true).setPosition(pointer.worldX+20, pointer.worldY-20);
                        }
                        else if (handcurrent === hand.grain_scoop) {
                            grain_held_sprite.setVisible(true).setPosition(pointer.worldX, pointer.worldY);
                        }
                        else if (handcurrent === hand.brush) {
                            brush_held_sprite.setVisible(true).setPosition(pointer.worldX, pointer.worldY);
                        }
                        else if (handcurrent === hand.hoofpick) {
                            hoofpick_held_sprite.setVisible(true).setPosition(pointer.worldX, pointer.worldY);
                        }
                        else {
                            shovel_held_sprite.setVisible(false);
                            fork_held_sprite.setVisible(false);
                            grain_held_sprite.setVisible(false);
                            brush_held_sprite.setVisible(false);
                            hoofpick_held_sprite.setVisible(false);
                        }
                    }
                }

                
                const config = {
                    type: Phaser.AUTO,
                    width: 853,
                    height: 501,
                    scene: Example
                };

                const game = new Phaser.Game(config);
        
            </script>
        </div>

    </body>
</html>